<!DOCTYPE html>
<html>
<head>
    <title>Hydration MVP</title>
    <style>body { font-family: monospace; background: #222; color: #0f0; padding: 20px; }</style>
</head>
<body>
    <h2>Hydration Status:</h2>
    <div id="logs"></div>

    <script>
        const logsEl = document.getElementById('logs');
        function log(msg, data) {
            logsEl.innerHTML += "<p>[" + msg + "] " + (data ? JSON.stringify(data) : '') + "</p>";
        }

        // 1. Initial State Check
        if (typeof window !== 'undefined' && window.openai) {
            log("INIT window.openai exists:", {
              toolOutput: !!window.openai.toolOutput,
              structuredContent: !!window.openai.structuredContent,
            });
            log("INIT toolOutput =", window.openai.toolOutput);
            log("INIT structuredContent =", window.openai.structuredContent);
        } else {
            log("INIT window.openai NOT found");
        }

        // 2. Legacy / Travel Checklist pattern Event Listener
        window.addEventListener('openai:set_globals', (ev) => {
            log("EVENT openai:set_globals received:", ev?.detail?.globals);
        });

        // 3. Official Apps SDK JSON-RPC Pattern
        let rpcId = 0;
        const pendingReqs = new Map();
        
        function rpcNotify(method, params) {
            window.parent.postMessage({ jsonrpc: "2.0", method, params }, "*");
        }
        
        function rpcRequest(method, params) {
            return new Promise((resolve, reject) => {
                const id = ++rpcId;
                pendingReqs.set(id, { resolve, reject });
                window.parent.postMessage({ jsonrpc: "2.0", id, method, params }, "*");
            });
        }

        window.addEventListener("message", (event) => {
            if (event.source !== window.parent) return;
            const message = event.data;
            if (!message || message.jsonrpc !== "2.0") return;

            if (typeof message.id === "number") {
                const pending = pendingReqs.get(message.id);
                if (!pending) return;
                pendingReqs.delete(message.id);
                if (message.error) pending.reject(message.error);
                else pending.resolve(message.result);
                return;
            }

            if (message.method === "ui/notifications/tool-result") {
                log("RPC TOOL RESULT received:", message.params);
            }
        });

        // SDK Handshake
        async function handshake() {
            try {
                log("RPC handshake starting...");
                await rpcRequest("ui/initialize", {
                    appInfo: { name: "hydration_test", version: "1.0.0" },
                    appCapabilities: {},
                    protocolVersion: "2026-01-26"
                });
                rpcNotify("ui/notifications/initialized", {});
                log("RPC handshake completed");
            } catch (err) {
                log("RPC handshake failed:", err);
            }
        }
        
        setTimeout(handshake, 500);
    </script>
</body>
</html>
